# Apple Pay 订阅功能测试文档

## 概述

本文档详细描述了 Apple Pay 订阅功能的测试流程和注意事项，涵盖了从首次购买到各种订阅生命周期事件的全面测试方案。

## 测试环境

- **沙盒环境**：使用 Apple 提供的沙盒测试环境进行测试
- **测试账户**：在 App Store Connect 中创建的沙盒测试账户
- **测试设备**：真实的 iOS 设备（模拟器不支持 Apple Pay）

## 沙盒环境续订时间表

在沙盒环境中，Apple 会加速订阅周期以便于测试：

| 实际订阅周期 | 沙盒续订频率 |
|------------|------------|
| 1 周       | 每 3-4 分钟 |
| 1 个月     | 每 5 分钟   |
| 2 个月     | 每 10 分钟  |
| 3 个月     | 每 15 分钟  |
| 6 个月     | 每 30 分钟  |
| 1 年       | 每 1 小时   |

## 基础功能测试

### 1. 首次购买订阅测试

#### 1.1 月度订阅购买
- [ ] 使用沙盒账户购买月度订阅
- [ ] 验证支付流程是否正常完成
- [ ] 检查后端是否正确接收到收据并验证
- [ ] 确认用户订阅状态更新为 "active"
- [ ] 验证订阅到期日期正确设置

#### 1.2 季度订阅购买
- [ ] 使用沙盒账户购买季度订阅
- [ ] 验证支付流程是否正常完成
- [ ] 检查后端是否正确接收到收据并验证
- [ ] 确认用户订阅状态更新为 "active"
- [ ] 验证订阅到期日期正确设置

#### 1.3 年度订阅购买
- [ ] 使用沙盒账户购买年度订阅
- [ ] 验证支付流程是否正常完成
- [ ] 检查后端是否正确接收到收据并验证
- [ ] 确认用户订阅状态更新为 "active"
- [ ] 验证订阅到期日期正确设置

### 2. 订阅续订测试

#### 2.1 月度订阅续订
- [ ] 等待沙盒环境的续订周期（5分钟）
- [ ] 监控后端是否接收到 Apple 的续订通知
- [ ] 验证订阅状态保持为 "active"
- [ ] 确认订阅到期日期正确更新
- [ ] 检查订阅事件日志记录

#### 2.2 季度订阅续订
- [ ] 等待沙盒环境的续订周期（15分钟）
- [ ] 监控后端是否接收到 Apple 的续订通知
- [ ] 验证订阅状态保持为 "active"
- [ ] 确认订阅到期日期正确更新
- [ ] 检查订阅事件日志记录

#### 2.3 年度订阅续订
- [ ] 等待沙盒环境的续订周期（1小时）
- [ ] 监控后端是否接收到 Apple 的续订通知
- [ ] 验证订阅状态保持为 "active"
- [ ] 确认订阅到期日期正确更新
- [ ] 检查订阅事件日志记录

### 3. 订阅升级/降级测试

#### 3.1 订阅升级（月升级年）
- [ ] 在用户拥有有效月度订阅时，购买年度订阅
- [ ] 验证升级流程是否正常完成
- [ ] 确认 prorated charges（按比例收费）正确处理
- [ ] 验证新订阅状态和到期日期正确设置

#### 3.2 订阅降级（年降级月）
- [ ] 在用户拥有有效年度订阅时，购买月度订阅
- [ ] 验证降级流程是否正常完成
- [ ] 确认降级在当前订阅期结束后生效
- [ ] 验证新订阅状态和到期日期正确设置

## 订阅生命周期测试

### 4. 取消自动续订测试

- [ ] 用户在设备设置中关闭自动续订
- [ ] 验证后端是否接收到 DID_CHANGE_RENEWAL_STATUS 通知
- [ ] 确认订阅状态更新为 "cancelled"
- [ ] 验证用户仍然可以使用订阅直到到期
- [ ] 确认到期后订阅状态更新为 "expired"

### 5. 订阅过期测试

- [ ] 等待订阅自然到期
- [ ] 监控后端是否接收到 EXPIRED 通知
- [ ] 验证订阅状态更新为 "expired"
- [ ] 确认用户失去订阅访问权限
- [ ] 检查订阅事件日志记录

### 6. 续订失败测试

- [ ] 模拟续订失败情况（如付款方式无效）
- [ ] 监控后端是否接收到 DID_FAIL_TO_RENEW 通知
- [ ] 验证订阅状态更新为 "grace_period"
- [ ] 确认用户在宽限期内仍然可以访问
- [ ] 等待宽限期结束，验证订阅状态更新为 "expired"

### 7. 退款处理测试

- [ ] 在 App Store Connect 中为用户处理退款
- [ ] 监控后端是否接收到 REFUND 通知
- [ ] 验证订阅状态更新为 "refunded"
- [ ] 确认用户失去订阅访问权限
- [ ] 检查订阅事件日志记录

### 8. 价格变更测试

#### 8.1 用户接受价格变更
- [ ] 设置订阅价格增加
- [ ] 监控后端是否接收到 PRICE_INCREASE 通知（subtype: ACCEPTED）
- [ ] 验证用户接受价格变更后的处理
- [ ] 确认续订按新价格进行

#### 8.2 用户拒绝价格变更
- [ ] 设置订阅价格增加
- [ ] 监控后端是否接收到 PRICE_INCREASE 通知（subtype: DECLINED）
- [ ] 验证用户拒绝价格变更后的处理
- [ ] 确认订阅在当前周期结束后终止

## 特殊情况测试

### 9. 重复通知处理测试

- [ ] 模拟 Apple 重复发送同一通知
- [ ] 验证后端是否正确识别并处理重复通知
- [ ] 确认不会产生重复的状态更新
- [ ] 验证幂等性处理机制正常工作

### 10. 恢复购买测试

- [ ] 在新设备上登录同一 Apple ID
- [ ] 使用恢复购买功能
- [ ] 验证是否能正确恢复已有订阅
- [ ] 确认用户订阅状态正确同步

### 11. 网络异常处理测试

- [ ] 在网络中断时尝试购买订阅
- [ ] 验证应用是否正确处理网络错误
- [ ] 确认在网络恢复后能够正确同步状态
- [ ] 测试收据验证失败后的重试机制

## 多设备同步测试

### 12. 多设备订阅状态同步

- [ ] 在多个设备上使用同一 Apple ID
- [ ] 在一个设备上购买订阅
- [ ] 验证其他设备是否能正确同步订阅状态
- [ ] 测试在不同设备上的续订状态同步

## 异常情况测试

### 13. 重复购买处理

- [ ] 尝试重复购买同一订阅产品
- [ ] 验证应用是否正确阻止重复购买
- [ ] 确认用户收到相应提示信息

### 14. 无效收据处理

- [ ] 模拟发送无效收据到后端
- [ ] 验证后端是否正确识别并拒绝无效收据
- [ ] 确认返回适当的错误信息

## 日志和监控测试

### 15. 订阅事件日志记录

- [ ] 验证所有订阅事件都被正确记录
- [ ] 检查日志包含必要的信息（时间、事件类型、用户ID等）
- [ ] 确认日志格式一致且易于分析

### 16. 错误处理日志记录

- [ ] 验证所有错误情况都被正确记录
- [ ] 检查错误日志包含足够的调试信息
- [ ] 确认错误处理不会导致系统崩溃

## 性能测试

### 17. 高并发购买测试

- [ ] 模拟多个用户同时购买订阅
- [ ] 验证系统是否能正确处理并发请求
- [ ] 确认数据库更新操作的原子性

### 18. 通知处理性能测试

- [ ] 模拟短时间内接收到大量 Apple 通知
- [ ] 验证后端是否能及时处理所有通知
- [ ] 确认不会因为处理延迟导致状态不一致

## 安全测试

### 19. 收据验证安全性

- [ ] 验证收据验证过程的安全性
- [ ] 确认不会信任客户端发送的未经验证的数据
- [ ] 验证与 Apple 服务器的通信安全性

### 20. 数据传输安全性

- [ ] 确认所有 API 调用都使用 HTTPS
- [ ] 验证敏感数据的加密存储
- [ ] 检查访问控制机制的有效性

## 测试完成标准

所有测试用例都应该通过，特别是：
1. 订阅状态的正确转换
2. Apple 通知的正确处理
3. 用户体验的流畅性
4. 系统的稳定性和安全性
5. 数据的一致性和完整性

## 注意事项

1. **测试时间规划**：由于沙盒环境的加速续订，合理安排测试时间
2. **日志监控**：保持对后端日志的持续监控
3. **数据清理**：测试完成后清理测试数据
4. **真实环境验证**：在可能的情况下，在生产环境中进行最终验证