# Apple Pay 订阅前后端集成指南

## 概述

本指南介绍了如何处理前端检测到的已购买状态并通知后端的完整解决方案。

## 业务场景

当前端检测到用户已购买订阅时（`PurchaseStatus.restored`），需要通知后端进行处理，因为可能存在以下情况：

1. **后端未收到苹果通知** - 苹果的服务器通知可能延迟或失败
2. **通知处理失败** - 后端处理苹果通知时发生错误
3. **跨设备购买** - 用户在其他设备购买，当前设备首次恢复
4. **数据同步问题** - 前后端数据不一致

## 解决方案架构

### 前端流程

```
用户点击购买
    ↓
检测到 PurchaseStatus.restored
    ↓
1. 显示"已拥有产品"提示
2. 通知后端恢复购买状态
3. (可选) 验证收据
```

### 后端处理流程

```
接收前端通知
    ↓
检查是否存在订阅记录
    ↓
不存在: 创建待验证记录  |  存在: 更新状态
    ↓
返回处理结果
    ↓
(可选) 触发收据验证
```

## 实现细节

### 1. 后端 API 端点

#### POST /api/subscriptions/handle-restored-purchase

处理前端恢复购买通知

**请求参数:**

```json
{
  "userId": "test-user-001",
  "productId": "year",
  "originalTransactionId": "2000000994282642",
  "purchaseId": "2000000994282642",
  "environment": "Sandbox"
}
```

**响应:**

```json
{
  "success": true,
  "message": "已处理恢复购买通知，订阅状态已更新为待验证",
  "data": {
    "user": {
      "userId": "test-user-001",
      "subscriptionStatus": "pending_verification",
      "subscriptionType": "yearly"
    },
    "subscription": {
      "productId": "year",
      "status": "pending_verification",
      "originalTransactionId": "2000000994282642"
    },
    "needsVerification": true
  }
}
```

#### POST /api/subscriptions/verify-restored-purchase

验证恢复购买的收据

**请求参数:**

```json
{
  "userId": "test-user-001",
  "receiptData": "base64_encoded_receipt",
  "originalTransactionId": "2000000994282642"
}
```

### 2. 前端实现

#### ApiService 类

提供与后端通信的方法：

- `notifyRestoredPurchase()` - 通知后端恢复购买
- `verifyRestoredPurchase()` - 验证收据
- `getUserSubscriptionStatus()` - 获取用户订阅状态
- `retryApiCall()` - 重试机制

#### SubscriptionService 更新

在检测到`PurchaseStatus.restored`时自动调用后端 API：

```dart
else if (purchase.status == PurchaseStatus.restored) {
  print('恢复的购买: ${purchase.productID}');
  _purchasedProducts.add(purchase.productID);

  // 通知后端处理恢复购买
  _notifyBackendRestoredPurchase(purchase);

  onProductAlreadyOwned?.call('检测到您已拥有此产品，已为您恢复购买');
}
```

## 错误处理策略

### 1. 网络错误处理

- 自动重试机制（默认 3 次）
- 超时处理（30 秒）
- 降级策略（允许前端继续使用，后台异步处理）

### 2. 后端错误处理

- 创建待验证状态的订阅记录
- 记录错误日志
- 支持手动重新处理

### 3. 用户体验保障

- 前端通知后端失败不影响用户体验
- 提供调试工具查看详细状态
- 清晰的错误提示信息

## 配置说明

### 1. 后端配置

- 确保数据库连接正常
- 配置苹果验证环境（Sandbox/Production）
- 设置适当的日志级别

### 2. 前端配置

- 更新`ApiService`中的`baseUrl`
- 设置正确的用户 ID 获取逻辑
- 配置产品 ID 映射

### 3. 网络配置

- 确保前端可以访问后端 API
- 配置适当的超时时间
- 处理网络异常情况

## 测试流程

### 1. 单元测试

- 测试 API 调用成功/失败情况
- 测试重试机制
- 测试错误处理

### 2. 集成测试

- 模拟恢复购买场景
- 测试前后端数据一致性
- 测试网络异常处理

### 3. 用户测试

- 在不同设备上测试恢复购买
- 测试网络不稳定情况
- 验证用户体验流畅性

## 监控和调试

### 1. 日志记录

- 前端：详细的购买状态日志
- 后端：API 调用和处理结果日志
- 苹果：通知接收和处理日志

### 2. 调试工具

- 前端调试检查按钮
- 后端状态查询接口
- 购买状态对比工具

### 3. 监控指标

- API 调用成功率
- 恢复购买处理时间
- 用户订阅状态一致性

## 常见问题

### Q1: 前端检测到已购买，但后端没有记录怎么办？

A: 系统会自动创建待验证状态的订阅记录，并建议进行收据验证。

### Q2: 网络请求失败会影响用户体验吗？

A: 不会。前端会显示"已拥有产品"，后端通知失败只会记录日志，不影响用户使用。

### Q3: 如何确保数据一致性？

A: 通过定期同步、收据验证和状态对比来保证数据一致性。

### Q4: 如何处理重复通知？

A: 后端会检查现有记录，避免重复创建，并更新现有记录状态。

## 最佳实践

1. **异步处理** - 后端通知不阻塞用户操作
2. **幂等性** - 重复调用不会产生副作用
3. **降级策略** - 网络失败时的备用方案
4. **监控告警** - 及时发现和处理问题
5. **用户友好** - 清晰的状态提示和错误信息

## 部署注意事项

1. 确保后端服务正常运行
2. 检查网络连接和防火墙设置
3. 验证苹果服务器通知配置
4. 测试完整的购买恢复流程
5. 监控日志和错误率

---

通过这个完整的解决方案，可以有效处理前端检测到已购买状态时的后端同步问题，确保用户订阅数据的一致性和准确性。
